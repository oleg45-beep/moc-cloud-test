from flask import Blueprint, request, jsonify, session
import sqlite3
import json
import random
from datetime import datetime

assistant_bp = Blueprint('assistant', __name__)

def get_db():
    conn = sqlite3.connect('database/moc.db')
    conn.row_factory = sqlite3.Row
    return conn

@assistant_bp.route('/chat', methods=['POST'])
def assistant_chat():
    """–ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –û–ª–µ–≥–æ–º"""
    if 'user_id' not in session:
        return jsonify({"error": "Unauthorized"}), 401
    
    user_id = session['user_id']
    
    try:
        data = request.json
        message = data.get('message', '').lower().strip()
        
        if not message:
            return jsonify({"error": "Message is required"}), 400
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        conn = get_db()
        cursor = conn.cursor()
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute('SELECT username FROM users WHERE id = ?', (user_id,))
        user = cursor.fetchone()
        username = user['username'] if user else '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
        
        cursor.execute('SELECT COUNT(*) FROM photos WHERE user_id = ?', (user_id,))
        photos_count = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) FROM albums WHERE user_id = ?', (user_id,))
        albums_count = cursor.fetchone()[0]
        
        conn.close()
        
        # –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        responses = {
            '–ø—Ä–∏–≤–µ—Ç': [
                f"–ü—Ä–∏–≤–µ—Ç, {username}! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å! ü§ñ",
                f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {username}! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üíú"
            ],
            '–∫–∞–∫ –¥–µ–ª–∞': [
                "–û—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤–∞–º —Å —Ñ–æ—Ç–æ –∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏!",
                "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –í–∏–∂—É —É –≤–∞—Å {photos_count} —Ñ–æ—Ç–æ –≤ {albums_count} –∞–ª—å–±–æ–º–∞—Ö. –•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º?"
            ],
            '—Å–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º': [
                "–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –ö–∞–∫ –Ω–∞–∑–æ–≤—ë–º –∞–ª—å–±–æ–º?",
                "–°–æ–∑–¥–∞–º –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –ö–∞–∫—É—é —Ç–µ–º—É –≤—ã–±—Ä–∞—Ç—å: '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–°–µ–º—å—è', '–î—Ä—É–∑—å—è' –∏–ª–∏ –ø—Ä–∏–¥—É–º–∞–µ—Ç–µ —Å–≤–æ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ?"
            ],
            '–º–æ–∏ —Ñ–æ—Ç–æ': [
                f"–£ –≤–∞—Å {photos_count} —Ñ–æ—Ç–æ. –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ö –≤—Å–µ –∏–ª–∏ –Ω–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ?",
                f"–Ø –≤–∏–∂—É {photos_count} –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ '–ú–æ–∏ —Ñ–æ—Ç–æ' –≤ –º–µ–Ω—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞."
            ],
            '—É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ': [
                "–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ, –æ—Ç–∫—Ä–æ–π—Ç–µ –∞–ª—å–±–æ–º, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ '–£–¥–∞–ª–∏—Ç—å'.",
                "–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ ‚Äî –≤ –∞–ª—å–±–æ–º–∞—Ö. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É."
            ],
            '—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ': [
                "–í—Å–µ –≤–∞—à–∏ —Ñ–æ—Ç–æ —à–∏—Ñ—Ä—É—é—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º XChaCha20 –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π! üîê",
                "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ! –ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á —Ç–æ–ª—å–∫–æ —É –≤–∞—Å, —Ñ–∞–π–ª—ã –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
            ],
            '–ø—Ä–æ—Ñ–∏–ª—å': [
                "–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∞—à –∞–≤–∞—Ç–∞—Ä –∏ –≤—ã–±–µ—Ä–∏—Ç–µ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'.",
                "–í –ø—Ä–æ—Ñ–∏–ª–µ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å email, –∏–º—è –∏ –∞–≤–∞—Ç–∞—Ä. –ü–∞—Ä–æ–ª—å –º–µ–Ω—è–µ—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
            ],
            '—á–∞—Ç': [
                "–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª '–ß–∞—Ç—ã' –∏ –Ω–∞–∂–º–∏—Ç–µ '–ù–æ–≤—ã–π —á–∞—Ç'.",
                "–í —á–∞—Ç–∞—Ö –º–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã!"
            ],
            '–ø–æ–º–æ—â—å': [
                "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å: —Ñ–æ—Ç–æ, –∞–ª—å–±–æ–º–∞–º–∏, –ø—Ä–æ—Ñ–∏–ª–µ–º, —á–∞—Ç–∞–º–∏, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?",
                "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: —Å–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º, –º–æ–∏ —Ñ–æ—Ç–æ, –ø—Ä–æ—Ñ–∏–ª—å, —á–∞—Ç—ã, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–º–æ—â—å."
            ],
            '—Å–ø–∞—Å–∏–±–æ': [
                "–í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å, {username}! üíú",
                "–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å! –í–∞—à–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–æ –º–Ω–æ–π! ü§ñ"
            ]
        }
        
        # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
        response = None
        for key in responses:
            if key in message:
                response = random.choice(responses[key])
                break
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –æ—Ç–≤–µ—Ç
        if not response:
            general_responses = [
                f"–Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –û–ª–µ–≥! –ú–æ–≥—É –ø–æ–º–æ—á—å —Å —Ñ–æ—Ç–æ, –∞–ª—å–±–æ–º–∞–º–∏ ({albums_count} —à—Ç.) –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.",
                f"–í–∏–∂—É —É –≤–∞—Å {photos_count} —Ñ–æ—Ç–æ. –•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –∏–ª–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏?",
                "–°–ø—Ä–æ—Å–∏—Ç–µ '–ø–æ–º–æ—â—å' –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ: '—Å–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º', '–º–æ–∏ —Ñ–æ—Ç–æ', '–ø—Ä–æ—Ñ–∏–ª—å'.",
                f"–ü—Ä–∏–≤–µ—Ç, {username}! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤–∞—à–∏ {photos_count} –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π!"
            ]
            response = random.choice(general_responses)
        
        # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
        response = response.replace('{username}', username)
        response = response.replace('{photos_count}', str(photos_count))
        response = response.replace('{albums_count}', str(albums_count))
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞
        actions = []
        if '–∞–ª—å–±–æ–º' in message:
            actions.append({"type": "create_album", "label": "–°–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º"})
        if '—Ñ–æ—Ç–æ' in message or '—Å–º–æ—Ç—Ä–µ—Ç—å' in message:
            actions.append({"type": "view_photos", "label": "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ"})
        if '–ø—Ä–æ—Ñ–∏–ª—å' in message:
            actions.append({"type": "edit_profile", "label": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"})
        if '—á–∞—Ç' in message:
            actions.append({"type": "create_chat", "label": "–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"})
        
        # –°—Ç–∞—Ç—É—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–º–µ–Ω—è—é—â–∏–π—Å—è)
        statuses = ['online', 'typing', 'thinking', 'online']
        status = random.choice(statuses)
        
        return jsonify({
            "success": True,
            "response": response,
            "assistant": {
                "name": "–û–ª–µ–≥",
                "status": status,
                "avatar": "ü§ñ",
                "timestamp": datetime.now().isoformat()
            },
            "actions": actions,
            "suggestions": [
                "–°–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º",
                "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ —Ñ–æ—Ç–æ", 
                "–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å",
                "–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç",
                "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ?"
            ]
        })
        
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@assistant_bp.route('/quick_action', methods=['POST'])
def quick_action():
    """–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
    if 'user_id' not in session:
        return jsonify({"error": "Unauthorized"}), 401
    
    action = request.json.get('action')
    
    actions = {
        'create_album': {
            "message": "–û—Ç–∫—Ä—ã–≤–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞...",
            "redirect": "#albums",
            "modal": "createAlbumModal"
        },
        'view_photos': {
            "message": "–ü–æ–∫–∞–∑—ã–≤–∞—é –≤–∞—à–∏ —Ñ–æ—Ç–æ...",
            "redirect": "#albums",
            "scroll_to": "myPhotos"
        },
        'edit_profile': {
            "message": "–û—Ç–∫—Ä—ã–≤–∞—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...",
            "modal": "profileModal"
        },
        'create_chat': {
            "message": "–°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π —á–∞—Ç...",
            "redirect": "#chats",
            "modal": "createChatModal"
        }
    }
    
    if action in actions:
        return jsonify({
            "success": True,
            **actions[action]
        })
    
    return jsonify({
        "success": False,
        "error": "Unknown action"
    }), 400
